# tuning03

## 重たいバッチSQLの特定と改善(作業時間目安40分)
この章ではバッチ処理業務でデータ作成処理を行っている状況を想定しています。

### 確認
curlとブラウザで「/tuning03」を開きましょう。数分後に「バッチ処理insert 成功!」のレスポンスがあれば確認成功です。curlでは実行時間も確認しましょう。

#### [ターミナル1] curlで確認
例では16分以上掛かっています注意！

```
$ time curl http://localhost/tuning03
バッチ処理insert 成功!
real    16m41.340s
user    0m0.022s
sys     0m0.028s
```

#### 実行後に作られたデータの確認
tuning03.phpに記載されたSQLと確認したデータからどのような意図(目的)のSQLか考えましょう

```
mysql> select * from user_birth_month_count;
+-----+-------+-------+
| sex | month | count |
+-----+-------+-------+
|   0 |     1 | 42498 |
|   0 |     2 | 38383 |
|   0 |     3 | 42435 |
|   0 |     4 | 41250 |
|   0 |     5 | 42448 |
|   0 |     6 | 40793 |
|   0 |     7 | 42642 |
|   0 |     8 | 42803 |
|   0 |     9 | 40791 |
|   0 |    10 | 42090 |
|   0 |    11 | 40903 |
|   0 |    12 | 42719 |
|   1 |     1 | 42186 |
|   1 |     2 | 38878 |
|   1 |     3 | 42509 |
|   1 |     4 | 41535 |
|   1 |     5 | 42551 |
|   1 |     6 | 40914 |
|   1 |     7 | 42566 |
|   1 |     8 | 42768 |
|   1 |     9 | 41087 |
|   1 |    10 | 41970 |
|   1 |    11 | 41021 |
|   1 |    12 | 42266 |
+-----+-------+-------+
24 rows in set (0.00 sec)
```

### 負荷検証
今回はsiegeは使わず、curl、もしくはブラウザから「/tuning03」を呼び出しましょう。呼び出し中にターミナル[2-4]の確認を行いましょう

#### [ターミナル1] curlで確認
実行時間が長いためチームメンバー全員が行う必要はありません。

```
$ curl http://localhost/tuning03
```

#### [ターミナル2] processlistの確認
何度かprocesslistの確認は行いましょう

```
mysql> show full purocesslist;
```

#### [ターミナル3] MySQL スローログの確認
`tail`で出力しているスローログが、siege実行中にスローログが出ているか確認しましょう


#### [ターミナル4] リソース統計情報の確認
curl、ブラウザでchapter4を実行中にどのリソースが利用されているか、実行前との違いなども確認しましょう

### 確認
/tuning03のSQLはどういうことをしているか確認しましょう

### 実行計画確認
ターミナル2,3で出力されたSQLをターミナル2で`explain`を使い確認しましょう  

----

### Mission ボトルネックSQLの改善

**重要** **このミッションではINDEXの作成は行うことを禁止します。(それ以外の改善施策はOKです)**

実行計画確認で洗い出したボトルネックと思われるSQLを性能改善しましょう。改善後「/1day/chapter4」を実行しどのように改善されたか確認しましょう。**explainの改善前後の確認は必ずしましょう**。各ターミナルから出力される内容がどのように変わったか確認しましょう

#### ヒント
FullScanがunion回数分行われています。SQLを組み直して減らしましょう

**目標　2分を切りましょう!**
----

